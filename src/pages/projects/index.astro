---
import { getCollection } from "astro:content";
import { format } from "date-fns";
import { ArrowLeft, ExternalLink } from "lucide-preact";

import Footer from "~/components/Footer.astro";
import Head from "~/components/Head.astro";
import { SITE_TITLE } from "~/constants";
import Document from "~/layouts/Document.astro";
import { loadIcon } from "~/utils/icon";

const projects = await getCollection("projects").then((projects) =>
  projects
    .sort((a, b) => b.data.date.valueOf() - a.data.date.valueOf())
    .map(({ data }) => data),
);

const statusConfig = {
  production: { label: "PROD", color: "text-green-500 border-green-500/50" },
  development: { label: "DEV", color: "text-cyan-500 border-cyan-500/50" },
  maintenance: {
    label: "MAINT",
    color: "text-yellow-500 border-yellow-500/50",
  },
  idea: { label: "IDEA", color: "text-purple-500 border-purple-500/50" },
  archived: { label: "ARCH", color: "text-gray-500 border-gray-500/50" },
};
---

<Head title={`${SITE_TITLE} ─ projects`} />

<Document>
  <main
    class="flex flex-col h-full mx-auto max-w-3xl px-4 sm:px-6 lg:px-8 py-16 space-y-12 pb-8"
  >
    <!-- Brutalist Hero -->
    <section class="space-y-4 pt-8">
      <h1
        class="font-[Fraunces] text-5xl sm:text-6xl font-bold tracking-tight text-gray-50 leading-[0.9]"
      >
        <span class="text-primary-500">◇</span> Projects
      </h1>
      <p class="text-gray-500 text-base">
        A collection of projects I've worked on, ranging from ideas to
        production applications.
      </p>
    </section>

    <div class="z-10">
      <div class="space-y-0">
        {
          projects.map(async (project) => {
            const Icon = await loadIcon(project.icon);
            const hasUrl = !!project.url;
            const status = project.status || "development";
            const statusInfo = statusConfig[status];
            const Component = hasUrl ? "a" : "div";

            return (
              <Component
                href={project.url}
                target={hasUrl ? "_blank" : undefined}
                rel={hasUrl ? "noopener noreferrer" : undefined}
                class={`group block py-4 px-4 -mx-4 border-b border-gray-800 default-transition relative
                ${hasUrl ? "hover:bg-gray-900 cursor-pointer" : ""}
                before:absolute before:left-0 before:top-0 before:bottom-0 before:w-0 before:bg-primary-500 before:transition-all before:duration-200
                ${hasUrl ? "hover:before:w-1" : ""}`}
              >
                <div class="flex items-start gap-4">
                  <div class="flex-shrink-0 mt-1 w-8 h-8 flex items-center justify-center border border-gray-800 group-hover:border-primary-500/50 bg-gray-900 default-transition">
                    <Icon class="w-4 h-4 text-gray-500 group-hover:text-primary-500 default-transition" />
                  </div>
                  <div class="flex-1 min-w-0">
                    <div class="flex items-start justify-between gap-4 mb-1">
                      <div class="flex items-center gap-3">
                        <h3 class="font-[Fraunces] text-base text-gray-100 group-hover:text-gray-50 default-transition">
                          {project.title}
                        </h3>
                        {hasUrl && (
                          <ExternalLink class="w-3 h-3 text-gray-600 group-hover:text-primary-500 default-transition" />
                        )}
                        <span
                          class={`inline-flex items-center px-2 py-0.5 text-xs font-mono uppercase tracking-wider border ${statusInfo.color}`}
                        >
                          {statusInfo.label}
                        </span>
                      </div>
                      <time class="font-mono text-xs text-gray-600 flex-shrink-0">
                        {format(new Date(project.date), "dd-MM-yyyy")}
                      </time>
                    </div>
                    {project.description && (
                      <p class="text-gray-500 text-sm line-clamp-2">
                        {project.description}
                      </p>
                    )}
                  </div>
                </div>
              </Component>
            );
          })
        }

        {
          projects.length === 0 && (
            <div class="text-center py-12">
              <p class="font-mono text-sm text-gray-600">
                <span class="text-primary-500">$</span> No projects yet. Check
                back soon!
              </p>
            </div>
          )
        }
      </div>
    </div>
  </main>

  <Footer class="max-w-3xl border-t border-gray-800">
    <div
      class="flex items-center justify-center mt-4 md:block md:order-1 md:mt-0"
    >
      <a
        class="default-focus mt-4 default-transition group inline-flex items-center justify-center space-x-2 px-3 py-1 font-mono text-xs uppercase tracking-wider text-gray-400 hover:text-primary-500 bg-gray-900 hover:bg-gray-800 border border-gray-800 hover:border-primary-500/50"
        href="/"
      >
        <ArrowLeft
          class="w-4 h-4 default-transition transform group-hover:-translate-x-1"
        />
        <span>Go back</span>
      </a>
    </div>
  </Footer>
</Document>
