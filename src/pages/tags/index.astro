---
import { getCollection } from "astro:content";
import { ArrowLeft, Tag } from "lucide-preact";

import Footer from "~/components/Footer.astro";
import Head from "~/components/Head.astro";
import Document from "~/layouts/Document.astro";
import { filterPosts } from "~/utils/content";
import { extractAllTags, generateTagSlug } from "~/utils/seo";
import { PAGE_SEO, SITE } from "~/config/seo";

// Get all posts and extract tags
const posts = await getCollection("posts", filterPosts({ archived: false }));
const tagCounts = extractAllTags(posts);

// Sort tags by count (most posts first), then alphabetically
const sortedTags = Array.from(tagCounts.entries())
	.sort((a, b) => {
		if (b[1] !== a[1]) return b[1] - a[1];
		return a[0].localeCompare(b[0]);
	})
	.map(([tag, count]) => ({
		name: tag,
		slug: generateTagSlug(tag),
		count,
		// Find the original casing from posts
		displayName:
			posts
				.flatMap((p) => p.data.tags || [])
				.find((t) => t.toLowerCase() === tag) || tag,
	}));

// Breadcrumbs for structured data
const breadcrumbs = [
	{ name: "Home", url: SITE.url },
	{ name: "Topics", url: `${SITE.url}/tags` },
];
---

<Head
	title={PAGE_SEO.tags.title}
	description={PAGE_SEO.tags.description}
	type="website"
	breadcrumbs={breadcrumbs}
/>

<Document>
	<main
		class="flex flex-col h-full mx-auto max-w-3xl px-4 sm:px-6 lg:px-8 py-16 space-y-12 pb-8"
	>
		<!-- Page Header -->
		<section class="space-y-4 pt-8">
			<h1
				class="font-[Fraunces] text-5xl sm:text-6xl font-bold tracking-tight text-gray-50 leading-[0.9]"
			>
				<span class="text-primary-500">â—‡</span> Topics
			</h1>
			<p class="text-gray-500 text-base">
				Browse articles by topic. Find tutorials and guides organized by
				technology and subject.
			</p>
		</section>

		<!-- Tags Grid -->
		<section class="z-10">
			<ul class="grid grid-cols-1 sm:grid-cols-2 gap-4" role="list">
				{
					sortedTags.map(({ displayName, slug, count }) => (
						<li>
							<a
								href={`/tags/${slug}`}
								class="group flex items-center justify-between p-4 bg-gray-900/50 border border-gray-800 hover:border-primary-500/50 hover:bg-gray-900 default-transition"
							>
								<div class="flex items-center space-x-3">
									<Tag class="w-4 h-4 text-gray-500 group-hover:text-primary-500 default-transition" />
									<span class="font-[Fraunces] text-lg text-gray-100 group-hover:text-gray-50 default-transition capitalize">
										{displayName}
									</span>
								</div>
								<span class="font-mono text-xs text-gray-600 group-hover:text-gray-500 default-transition">
									{count} {count === 1 ? "post" : "posts"}
								</span>
							</a>
						</li>
					))
				}
			</ul>
		</section>
	</main>

	<Footer class="max-w-3xl border-t border-gray-800">
		<div
			class="flex items-center justify-center mt-4 md:block md:order-1 md:mt-0"
		>
			<a
				class="default-focus mt-4 default-transition group inline-flex items-center justify-center space-x-2 px-3 py-1 font-mono text-xs uppercase tracking-wider text-gray-400 hover:text-primary-500 bg-gray-900 hover:bg-gray-800 border border-gray-800 hover:border-primary-500/50"
				href="/"
			>
				<ArrowLeft
					class="w-4 h-4 default-transition transform group-hover:-translate-x-1"
				/>
				<span>Go back</span>
			</a>
		</div>
	</Footer>
</Document>
