---
import { format } from "date-fns";
import { FlagTriangleRight } from "lucide-preact";

import { cn } from "~/utils/cn";
import { loadIcon } from "~/utils/icon";

import type { CollectionEntry } from "astro:content";

type Project = CollectionEntry<"projects">;

export interface Props {
  class?: string;
  projects: Array<Project["data"]>;
  id: string;
  title?: string;
  variant?: "default" | "borderless";
  href?: string;
}

const {
  class: className,
  projects,
  href,
  id,
  title,
  variant = "default",
} = Astro.props;
const hasUrl = !!href;
const TitleComponent = hasUrl ? "a" : "h3";
const anchorProps = hasUrl ? { href } : {};
---

<section
  class={cn(
    "bg-gray-950 overflow-auto",
    variant === "default" &&
      "border border-gray-800 px-2 pb-2",
    variant === "borderless" && "bg-transparent",
    className,
  )}
  id={id}
>
  {
    title && (
      <TitleComponent
        class={cn(
          "flex items-center font-mono text-xs uppercase tracking-[0.15em] text-gray-400 mb-6",
          hasUrl ? "hover:text-primary-500 default-transition default-focus" : "",
        )}
        {...anchorProps}
      >
        <span class="text-primary-500 mr-2">â—‡</span>
        {title}
      </TitleComponent>
    )
  }

  {
    projects.length > 0 ? (
      <ul
        class="flow-root"
        role="list"
      >
        {projects.map(async (project, index) => {
          const Icon = await loadIcon(project.icon);

          const hasUrl = !!project.url;
          const Component = hasUrl ? "a" : "div";

          const anchorProps = hasUrl
            ? {
                href: project.url,
                target: "_blank",
                rel: "noopener noreferrer",
              }
            : {};

          const showConnector = index + 1 !== projects.length;

          return (
            <li class="group relative pb-6">
              {showConnector ? (
                <span
                  aria-hidden={true}
                  class="absolute left-4 top-8 -ml-px h-full w-px bg-gray-800 z-0"
                />
              ) : null}

              <Component
                class="relative flex space-x-4 default-transition default-focus py-3 px-2 hover:bg-gray-900/50"
                {...anchorProps}
              >
                <div
                  class={cn(
                    "text-gray-500 group-hover:text-primary-500 h-8 w-8 flex items-center justify-center border border-gray-800 group-hover:border-primary-500/50 bg-gray-900 z-20 default-transition",
                  )}
                >
                  <Icon class="h-4 w-4" />
                </div>

                <div
                  class={cn(
                    "text-gray-400 flex min-w-0 flex-1 justify-between space-x-4 default-transition",
                    {
                      "group-hover:text-gray-300": hasUrl,
                    },
                  )}
                >
                  <div class="flex-1">
                    <div class="flex items-center justify-between">
                      <p
                        class="font-[Fraunces] text-sm text-gray-200 group-hover:text-gray-50 default-transition line-clamp-1"
                        title={project.title}
                      >
                        {project.title}
                      </p>
                      <time
                        class="font-mono text-xs text-gray-600 group-hover:text-gray-500 default-transition whitespace-nowrap"
                        datetime={project.date.toISOString()}
                        title={format(project.date, "PPP")}
                      >
                        {format(project.date, "dd-MM-yyyy")}
                      </time>
                    </div>
                    {project.description && (
                      <p
                        class="text-xs mt-1 line-clamp-2 text-gray-500"
                        title={project.description}
                      >
                        {project.description}
                      </p>
                    )}
                  </div>
                </div>
              </Component>
            </li>
          );
        })}
      </ul>
    ) : (
      <div class="h-full flex items-center justify-center py-12">
        <div class="space-y-4 text-center">
          <FlagTriangleRight class="mx-auto text-gray-600" />

          <h3 class="font-mono text-sm uppercase tracking-[0.1em] text-gray-400">
            No projects here yet
          </h3>

          <p class="text-gray-600 text-sm">
            More projects coming soon
          </p>
        </div>
      </div>
    )
  }
</section>
